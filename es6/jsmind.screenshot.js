/**
* @license BSD-3-Clause
* @copyright 2014-2022 hizzgdev@163.com
*
* Project Home:
*   https://github.com/hizzgdev/jsmind/
*/
"use strict";module.exports=function(t){if(!t)throw new Error("jsMind is not defined");const e=t.$;var i=function(t,e){return t.getPropertyValue(e)},a=function(t){var e=i(t,"visibility"),a=i(t,"display");return"hidden"!==e&&"none"!==a},n={rect:function(t,e,i,a,n,s){a<2*s&&(s=a/2),n<2*s&&(s=n/2),t.moveTo(e+s,i),t.arcTo(e+a,i,e+a,i+n,s),t.arcTo(e+a,i+n,e,i+n,s),t.arcTo(e,i+n,e,i,s),t.arcTo(e,i,e+a,i,s)},text_multiline:function(t,e,i,a,n,s,o){var r="",l=e.length,h=e.split(""),d=null;t.textAlign="left",t.textBaseline="top";for(var c=0;c<l;c++)d=r+h[c],t.measureText(d).width>n&&c>0?(t.fillText(r,i,a),r=h[c],a+=o):r=d;t.fillText(r,i,a)},text_ellipsis:function(t,e,i,a,s,o){var r=a+o/2;e=n.fittingString(t,e,s);t.textAlign="left",t.textBaseline="middle",t.fillText(e,i,r,s)},fittingString:function(t,e,i){var a=t.measureText(e).width,n=t.measureText("…").width;if(a<=i||a<=n)return e;for(var s=e.length;a>=i-n&&s-- >0;)e=e.substring(0,s),a=t.measureText(e).width;return e+"…"},image:function(t,e,i,a,s,o,r,l,h){var d=new Image;d.onload=function(){t.save(),t.translate(i,a),t.save(),t.beginPath(),n.rect(t,0,0,s,o,r),t.closePath(),t.clip(),t.translate(s/2,o/2),t.rotate(l*Math.PI/180),t.drawImage(d,-s/2,-o/2),t.restore(),t.restore(),h&&h()},d.src=e}};class s{constructor(t){this.jm=t,this.canvas_elem=null,this.canvas_ctx=null,this._inited=!1}init(){if(!this._inited){console.log("init");var t=e.c("canvas"),i=t.getContext("2d");this.canvas_elem=t,this.canvas_ctx=i,this.jm.view.e_panel.appendChild(t),this._inited=!0,this.resize()}}shoot(t){this.init(),this._draw(function(){t&&t(),this.clean()}.bind(this)),this._watermark()}shootDownload(){this.shoot(function(){this._download()}.bind(this))}shootAsDataURL(t){this.shoot(function(){t&&t(this.canvas_elem.toDataURL())}.bind(this))}resize(){this._inited&&(this.canvas_elem.width=this.jm.view.size.w,this.canvas_elem.height=this.jm.view.size.h)}clean(){var t=this.canvas_elem;this.canvas_ctx.clearRect(0,0,t.width,t.height)}_draw(t){var e=this.canvas_ctx;e.textAlign="left",e.textBaseline="top",this._draw_lines(function(){this._draw_nodes(t)}.bind(this))}_watermark(){var t=this.canvas_elem,i=this.canvas_ctx;i.textAlign="right",i.textBaseline="bottom",i.fillStyle="#000",i.font="11px Verdana,Arial,Helvetica,sans-serif",i.fillText("hizzgdev.github.io/jsmind",t.width-5.5,t.height-2.5),i.textAlign="left",i.fillText(e.w.location,5.5,t.height-2.5)}_draw_lines(t){this.jm.view.graph.copy_to(this.canvas_ctx,t)}_draw_nodes(t){var i,a=this.jm.mind.nodes;for(var n in a)i=a[n],this._draw_node(i);!function n(){console.log("check_node_ready"+new Date);var s=!0;for(var o in a)s&=(i=a[o]).ready;s?e.w.setTimeout(t,200):e.w.setTimeout(n,200)}()}_draw_node(t){var e=this.canvas_ctx,s=t._data.view,o=s.element,r=getComputedStyle(o);if(a(r)){var l=i(r,"background-color"),h=parseInt(i(r,"border-top-left-radius")),d=i(r,"color"),c=parseInt(i(r,"padding-left")),v=parseInt(i(r,"padding-right")),f=parseInt(i(r,"padding-top")),_=parseInt(i(r,"padding-bottom")),g=i(r,"text-overflow"),m=i(r,"font-style")+" "+i(r,"font-variant")+" "+i(r,"font-weight")+" "+i(r,"font-size")+"/"+i(r,"line-height")+" "+i(r,"font-family"),u={x:s.abs_x,y:s.abs_y,w:s.width+1,h:s.height+1},w={x:u.x+c,y:u.y+f,w:u.w-c-v,h:u.h-f-_};if(e.font=m,e.fillStyle=l,e.beginPath(),n.rect(e,u.x,u.y,u.w,u.h,h),e.closePath(),e.fill(),e.fillStyle=d,"background-image"in t.data){var p=i(r,"background-image").slice(5,-2);t.ready=!1;var x=0;"background-rotation"in t.data&&(x=t.data["background-rotation"]),n.image(e,p,u.x,u.y,u.w,u.h,h,x,(function(){t.ready=!0}))}if(t.topic)if("ellipsis"===g)n.text_ellipsis(e,t.topic,w.x,w.y,w.w,w.h);else{var y=parseInt(i(r,"line-height"));n.text_multiline(e,t.topic,w.x,w.y,w.w,w.h,y)}s.expander&&this._draw_expander(s.expander),"background-image"in t.data||(t.ready=!0)}else t.ready=!0}_draw_expander(t){var e=this.canvas_ctx,n=getComputedStyle(t);if(a(n)){var s=i(n,"left"),o=i(n,"top");i(n,"font");var r=parseInt(s),l=parseInt(o),h="+"===t.innerHTML;e.lineWidth=1,e.beginPath(),e.arc(r+7,l+7,5,0,2*Math.PI,!0),e.moveTo(r+10,l+7),e.lineTo(r+4,l+7),h&&(e.moveTo(r+7,l+4),e.lineTo(r+7,l+10)),e.closePath(),e.stroke()}}_download(){var t=this.canvas_elem,i=this.jm.mind.name+".png";if(navigator.msSaveBlob&&t.msToBlob){var a=t.msToBlob();navigator.msSaveBlob(a,i)}else{var n=this.canvas_elem.toDataURL(),s=e.c("a");if("download"in s){s.style.visibility="hidden",s.href=n,s.download=i,e.d.body.appendChild(s);var o=e.d.createEvent("MouseEvents");o.initEvent("click",!0,!0),s.dispatchEvent(o),e.d.body.removeChild(s)}else location.href=n}}jm_event_handle(e,i){e===t.event_type.resize&&this.resize()}}var o=new t.plugin("screenshot",(function(t){var e=new s(t);t.screenshot=e,t.shoot=function(){e.shoot()},t.add_event_listener((function(t,i){e.jm_event_handle.call(e,t,i)}))}));t.register_plugin(o)};
